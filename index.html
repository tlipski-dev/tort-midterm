<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tort Midterm</title>
<style>
  body{font-family:sans-serif;max-width:900px;margin:20px auto;padding:0 15px;background:#f6f7fb;color:#111}
  header{background:#111;color:#fff;padding:20px;border-radius:10px}
  header h1{margin:0}
  .toolbar{margin:15px 0;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{padding:10px 14px;border:1px solid #ccc;border-radius:8px;cursor:pointer;background:#fff}
  button.primary{background:#111;color:#fff;border-color:#111}
  .card{background:#fff;border:1px solid #ddd;border-radius:10px;padding:15px;margin:10px 0}
  .choices{display:grid;gap:8px;margin-top:10px}
  .choice{border:1px solid #ccc;border-radius:8px;padding:10px;background:#fafafe;text-align:left;cursor:pointer}
  .choice.correct{border-color:green;background:#e6ffed}
  .choice.incorrect{border-color:red;background:#ffe6e6}
  .feedback{margin-top:10px;display:none;padding:10px;border-radius:8px}
  .feedback.ok{background:#e6ffed;border:1px solid green}
  .feedback.no{background:#ffe6e6;border:1px solid red}
  #scorebox{margin-left:auto;background:#111;color:#fff;padding:8px 12px;border-radius:999px}
  #studyPanel{display:none}
  .pill{display:inline-block;padding:6px 10px;border:1px solid #ddd;border-radius:999px;margin:4px 6px 0 0;background:#fafafa}
  .muted{color:#666}
</style>
</head>
<body>
<header>
  <h1>Tort Midterm</h1>
</header>

<div class="toolbar">
  <button id="nextBtn" class="primary">Next question</button>
  <button id="revealBtn">Reveal answer</button>
  <button id="resetBtn">Reset session</button>
  <button id="studyBtn">Show study topics</button>
  <span id="scorebox">Score: <strong id="score">0</strong>/<span id="total">0</span></span>
</div>

<div id="quiz"></div>

<!-- Study Suggestions Panel -->
<div id="studyPanel" class="card">
  <h3>Study suggestions</h3>
  <div id="studyContent" class="muted">Answer some questions first, then click ‚ÄúShow study topics.‚Äù</div>
</div>

<script>
let QUESTIONS = [];
let score = 0;
let attempted = 0;

// Track results for study suggestions
let history = []; // entries: { topic, correct }

// Indices of questions the user has MASTERED this session (got correct at least once)
let mastered = new Set();

// Current question state
let currentIndex = null; // index into QUESTIONS
let lastIndex = null;    // to avoid immediate repeats on wrongs
let answered = false;

const quizEl = document.getElementById('quiz');
const scoreEl = document.getElementById('score');
const totalEl = document.getElementById('total');
const resetBtn = document.getElementById('resetBtn');
const revealBtn = document.getElementById('revealBtn');
const studyBtn = document.getElementById('studyBtn');
const nextBtn = document.getElementById('nextBtn');
const studyPanel = document.getElementById('studyPanel');
const studyContent = document.getElementById('studyContent');

async function loadQuestions() {
  try {
    const res = await fetch('questions.json', { cache: 'no-store' });
    if (!res.ok) throw new Error('Failed to load questions.json');
    QUESTIONS = await res.json();
  } catch (e) {
    QUESTIONS = [];
  }
  resetSession();
}

function resetSession() {
  score = 0;
  attempted = 0;
  mastered.clear();
  history = [];
  currentIndex = null;
  lastIndex = null;
  answered = false;

  scoreEl.textContent = score;
  totalEl.textContent = attempted;
  studyPanel.style.display = 'none';
  studyContent.textContent = 'Answer some questions first, then click ‚ÄúShow study topics.‚Äù';
  studyContent.classList.add('muted');

  renderRandomQuestion();
}

function getCandidateIndices() {
  // All indices not yet mastered
  const candidates = [];
  for (let i = 0; i < QUESTIONS.length; i++) {
    if (!mastered.has(i)) candidates.push(i);
  }
  return candidates;
}

function pickRandomIndex(candidates) {
  if (candidates.length === 0) return null;
  if (candidates.length === 1) return candidates[0];

  // Avoid immediate repeat of the last shown question if possible
  let idx;
  do {
    idx = candidates[Math.floor(Math.random() * candidates.length)];
  } while (idx === lastIndex && candidates.length > 1);
  return idx;
}

function renderRandomQuestion() {
  if (!QUESTIONS.length) {
    quizEl.innerHTML = '<div class="card"><strong>No questions found.</strong> Ensure questions.json is in the same folder.</div>';
    return;
  }

  const candidates = getCandidateIndices();

  if (candidates.length === 0) {
    // All mastered!
    quizEl.innerHTML = `
      <div class="card">
        <h3>Session complete üéâ</h3>
        <p>You‚Äôve answered all ${QUESTIONS.length} questions correctly at least once this session.</p>
        <p>Click <strong>Reset session</strong> to start over.</p>
      </div>`;
    return;
  }

  const idx = pickRandomIndex(candidates);
  currentIndex = idx;
  answered = false;

  const q = QUESTIONS[idx];

  quizEl.innerHTML = '';
  const card = document.createElement('div');
  card.className = 'card';

  const title = document.createElement('h3');
  title.textContent = q.question;
  card.appendChild(title);

  const choices = document.createElement('div');
  choices.className = 'choices';

  (q.choices || q.options || []).forEach((text, cIdx) => {
    const btn = document.createElement('button');
    btn.className = 'choice';
    btn.textContent = text;
    btn.addEventListener('click', () => onChoose(card, btn, cIdx === (q.answer_index ?? q.answer), q));
    choices.appendChild(btn);
  });

  const fb = document.createElement('div');
  fb.className = 'feedback';

  card.appendChild(choices);
  card.appendChild(fb);
  quizEl.appendChild(card);
}

function onChoose(card, btn, isCorrect, q) {
  const buttons = card.querySelectorAll('.choice');
  if ([...buttons].some(b => b.disabled)) return; // already answered/revealed

  buttons.forEach(b => b.disabled = true);
  // mark correct
  const ansIdx = (q.answer_index ?? q.answer);
  if (typeof ansIdx === 'number' && buttons[ansIdx]) buttons[ansIdx].classList.add('correct');
  // mark incorrect click
  if (!isCorrect) btn.classList.add('incorrect');

  const fb = card.querySelector('.feedback');
  fb.style.display = 'block';
  if (isCorrect) {
    fb.classList.add('ok');
    fb.innerHTML = `<strong>Correct!</strong><br>${q.explanation || ''}`;
    score++;
    // Mark this index as MASTERED so it won't reappear this session
    mastered.add(currentIndex);
  } else {
    fb.classList.add('no');
    fb.innerHTML = `<strong>Incorrect.</strong> Correct answer: <em>${(q.choices || q.options)[ansIdx]}</em><br>${q.explanation || ''}`;
    // Do NOT add to mastered; it can show again later
  }

  attempted++;
  scoreEl.textContent = score;
  totalEl.textContent = attempted;

  history.push({ topic: q.topic || 'General', correct: isCorrect });
  answered = true;
  lastIndex = currentIndex;
}

revealBtn.addEventListener('click', () => {
  const card = document.querySelector('.card');
  if (!card || answered) return; // don‚Äôt override an already answered state
  const q = QUESTIONS[currentIndex];
  const buttons = card.querySelectorAll('.choice');
  buttons.forEach(b => b.disabled = true);
  const ansIdx = (q.answer_index ?? q.answer);
  if (typeof ansIdx === 'number' && buttons[ansIdx]) buttons[ansIdx].classList.add('correct');

  const fb = card.querySelector('.feedback');
  fb.style.display = 'block';
  fb.classList.remove('no'); fb.classList.add('ok');
  fb.innerHTML = `<strong>Answer:</strong> <em>${(q.choices || q.options)[ansIdx]}</em><br>${q.explanation || ''}`;
  // Reveal DOES NOT mark as mastered or change score/attempt
  answered = true;
  lastIndex = currentIndex;
});

nextBtn.addEventListener('click', () => {
  renderRandomQuestion();
});

resetBtn.addEventListener('click', resetSession);

function buildStudySuggestions() {
  // Count wrong by topic
  const counts = {};
  history.forEach(r => {
    if (r && r.correct === false) {
      counts[r.topic] = (counts[r.topic] || 0) + 1;
    }
  });

  studyPanel.style.display = 'block';

  const topics = Object.keys(counts).sort((a, b) => counts[b] - counts[a]);

  if (topics.length === 0) {
    studyContent.innerHTML = `<span class="muted">Nice! No missed topics yet. Keep practicing or reveal answers to review explanations.</span>`;
    return;
  }

  const frag = document.createDocumentFragment();
  const intro = document.createElement('p');
  intro.textContent = 'Based on your missed questions, focus on:';
  frag.appendChild(intro);

  const list = document.createElement('div');
  topics.forEach(t => {
    const pill = document.createElement('span');
    pill.className = 'pill';
    pill.textContent = `${t}  ¬∑  ${counts[t]}`;
    list.appendChild(pill);
  });
  frag.appendChild(list);

  const notes = document.createElement('div');
  notes.className = 'muted';
  notes.style.marginTop = '8px';
  notes.innerHTML = `<div><strong>Tip:</strong> Write clean rule statements for each topic and test with fresh hypos.</div>`;
  frag.appendChild(notes);

  studyContent.innerHTML = '';
  studyContent.appendChild(frag);
}
studyBtn.addEventListener('click', buildStudySuggestions);

loadQuestions();
</script>
</body>
</html>
